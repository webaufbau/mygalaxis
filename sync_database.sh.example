#!/bin/bash

# DB-Zugangsdaten Aktiver Server (Quelle)
SRC_DB_USER="dbuser"
SRC_DB_PASS="dbpass"
SRC_DB_NAME="dbname"
SRC_DB_HOST="localhost"

# DB-Zugangsdaten Passiver Server (Ziel)
TARGET_USER="deployuser"
TARGET_SERVER="passive.server.com"
TARGET_DB_USER="dbuser"
TARGET_DB_PASS="dbpass"
TARGET_DB_NAME="dbname"
TARGET_DB_HOST="localhost"

# Temporäre Dump-Datei lokal
DUMP_FILE="/tmp/db_sync_dump.sql"

# Dump erzeugen (ohne Events, Routines etc. - anpassen falls nötig)
mysqldump -h "$SRC_DB_HOST" -u "$SRC_DB_USER" -p"$SRC_DB_PASS" --single-transaction --quick --lock-tables=false "$SRC_DB_NAME" > "$DUMP_FILE"
if [ $? -ne 0 ]; then
  echo "Fehler beim Dump der Quell-Datenbank"
  exit 1
fi

# Dump zur Zielmaschine übertragen
scp "$DUMP_FILE" "$TARGET_USER@$TARGET_SERVER:/tmp/"
if [ $? -ne 0 ]; then
  echo "Fehler beim Kopieren des Dumps zum Zielserver"
  exit 1
fi

# Auf Zielserver Dump importieren (Passwort ggf. per .my.cnf konfigurieren)
ssh "$TARGET_USER@$TARGET_SERVER" bash -c "'
  mysql -h \"$TARGET_DB_HOST\" -u \"$TARGET_DB_USER\" -p\"$TARGET_DB_PASS\" \"$TARGET_DB_NAME\" < /tmp/db_sync_dump.sql
  if [ \$? -ne 0 ]; then
    echo Fehler beim Importieren der Datenbank
    exit 1
  fi
  rm /tmp/db_sync_dump.sql
'"
if [ $? -ne 0 ]; then
  echo "Fehler beim Import auf dem Zielserver"
  exit 1
fi

# Lokalen Dump löschen
rm "$DUMP_FILE"

echo "Datenbanksynchronisation erfolgreich abgeschlossen."
exit 0
